{% extends "base.html" %}
{% block title %}PodglÄ…d ankiety - manager{% endblock %}

{% block content %}

<style>
.radar-container {
  width: 100%;
  max-width: 900px;
  margin: 40px auto 60px auto;
  height: 600px;
}
.radar-container canvas {
  width: 100% !important;
  height: 100% !important;
}

.table-container {
  max-width: 700px;
  margin: 20px auto;
}

.rating-group {
  display: flex;
  gap: 8px;
  margin-top: 5px;
}

/* Ukryj domyÅ›lne radio */
.rating-group input[type="radio"] {
  display: none;
}

/* Labely â€“ standardowe obrzeÅ¼e */
.rating-group label {
  position: relative;
  padding-left: 25px;
  cursor: default;
  user-select: none;
}

/* OkrÄ…g przed label */
.rating-group label::before {
  content: "";
  position: absolute;
  left: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 2px solid #6c757d;
  background-color: #fff;
}

/* Zaznaczenie â€“ pracownik niebieski */
.rating-group.employee input[type="radio"]:checked + label::before {
  background-color: #0d6efd;
  border-color: #0d6efd;
}

/* Zaznaczenie â€“ manager czarny */
.rating-group.manager input[type="radio"]:checked + label::before {
  background-color: #000;
  border-color: #000;
}

/* Tekst label w kolorze zaznaczenia */
.rating-group.employee input[type="radio"]:checked + label {
  color: #0d6efd;
}
.rating-group.manager input[type="radio"]:checked + label {
  color: #000;
}

/* Responsywne radio buttony na mobile */
@media (max-width: 576px) {
  .rating-group {
    flex-direction: row; /* nadal poziomo */
    flex-wrap: wrap;     /* zawijanie do nowego wiersza jeÅ›li nie mieÅ›ci siÄ™ w jednej linii */
    gap: 5px;
  }
  .rating-group label::before {
    width: 16px;
    height: 16px;
  }
  .rating-group label {
    font-size: 0.9rem; /* trochÄ™ mniejszy tekst, Å¼eby lepiej siÄ™ mieÅ›ciÅ‚o */
  }
}
</style>

<div class="container mt-4">

  <!-- ðŸ”¹ KARTA INFORMACYJNA -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h2 class="card-title mb-3">{{ survey.name }}</h2>

      <p class="mb-1 text-muted"><strong>Pracownik:</strong></p>
      <h4 class="text-primary mb-2">
        <i class="bi bi-person-vcard"></i> {{ viewed_user.get_full_name }}
      </h4>

      <p class="mb-1 text-muted"><strong>DziaÅ‚:</strong></p>
      <h5 class="text-secondary mb-3">{{ viewed_user.department.name }}</h5>

      {% if manager_user %}
        <p class="mb-1 text-muted"><strong>OceniajÄ…cy:</strong></p>
        <h5 class="text-dark mb-2">
          <i class="bi bi-person-gear"></i> {{ manager_user.get_full_name }}
        </h5>
      {% endif %}

      <p class="mb-0 text-muted">
        <strong>Data ankiety:</strong> {{ survey.created_at|date:"d.m.Y H:i" }}
      </p>
    </div>
  </div>

  <!-- ðŸ”¹ PYTANIA I ODPOWIEDZI -->
  <h4 class="text-secondary mb-3">Odpowiedzi pracownika i osoby oceniajÄ…cej:</h4>

  <div class="mt-4">
    {% for sq in survey.surveyquestion_set.all %}
      <div class="mb-3 p-3 border rounded shadow-sm bg-light">
        <p><strong>{{ forloop.counter }}. {{ sq.question.text }}</strong></p>

        <!-- Ocena pracownika -->
        {% for ans in answers_user %}
          {% if ans.question.id == sq.question.id %}
            {% if ans.scale_value %}
              <div>
                Ocena pracownika:
                <div class="rating-group employee">
                  {% for i in scale_range %}
                    <input type="radio" id="user_{{ sq.question.id }}_{{ i }}" name="user_{{ sq.question.id }}" value="{{ i }}" disabled
                      {% if ans.scale_value == i %}checked{% endif %}>
                    <label for="user_{{ sq.question.id }}_{{ i }}">{{ i }}</label>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            {% if ans.text_value %}
              <div class="mt-1"><strong>Komentarz pracownika:</strong> {{ ans.text_value }}</div>
            {% endif %}
          {% endif %}
        {% endfor %}

        <!-- Ocena managera -->
        {% for ans in answers_manager %}
          {% if ans.question.id == sq.question.id %}
            {% if ans.scale_value %}
              <div class="mt-2">
                Ocena osoby oceniajÄ…cej:
                <div class="rating-group manager">
                  {% for i in scale_range %}
                    <input type="radio" id="manager_{{ sq.question.id }}_{{ i }}" name="manager_{{ sq.question.id }}" value="{{ i }}" disabled
                      {% if ans.scale_value == i %}checked{% endif %}>
                    <label for="manager_{{ sq.question.id }}_{{ i }}">{{ i }}</label>
                  {% endfor %}
                </div>
              </div>
            {% endif %}
            {% if ans.text_value %}
              <div class="mt-1"><strong>Komentarz osoby oceniajÄ…cej:</strong> {{ ans.text_value }}</div>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <!-- ðŸ”¹ WYKRES RADAROWY / BARCHART -->
  {% if show_radar %}
  <div class="radar-container text-center my-4">
    <h3 class="my-4">Wykres kompetencji</h3>
    <canvas id="radarChart"></canvas>
  </div>
  {% endif %}

  <!-- ðŸ”¹ TABELA WYNIKÃ“W -->
  <div class="table-container pt-5">
    <table class="table table-bordered text-center">
      <thead class="table-light">
        <tr>
          <th>Kompetencja</th>
          <th>Pracownik [%]</th>
          <th>Osoba oceniajÄ…ca [%]</th>
        </tr>
      </thead>
      <tbody>
        {% for label, user_val, manager_val in radar_data %}
        <tr>
          <td>{{ label }}</td>
          <td>{{ user_val }}%</td>
          <td>{{ manager_val }}%</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- ðŸ”¹ SUMA PUNKTÃ“W -->
  <div class="text-center mt-4 mb-5">
    <div class="alert alert-secondary d-inline-block px-4 py-3 shadow-sm">
      <h5 class="mb-0">
        <strong>Suma uzyskanych punktÃ³w:</strong><br>
        {{ manager_total_points }} z {{ manager_max_points }} punktÃ³w
        ({{ manager_percentage }}%)
      </h5>
    </div>
  </div>

  {% if hr_comment %}
  <div class="card shadow-sm mt-4 mb-4 mx-auto" style="max-width: 600px;">
    <div class="card-body">
      <h5 class="card-title header-font text-primary fs-2 text-center">Komentarz dziaÅ‚u kadr</h5>
      <p class="card-text"><i>{{ hr_comment }}</i></p>
      <small class="text-muted">
        {% if hr_comment_user %}
          Dodany przez: {{ hr_comment_user.get_full_name }}<br>
        {% endif %}
        {% if hr_comment_date %}
          Data: {{ hr_comment_date|date:"d.m.Y H:i" }}
        {% endif %}
      </small>
    </div>
  </div>
  {% endif %}

  <!-- ðŸ”¹ PRZYCISK POWROTU -->
  <div class="text-center my-4">
    <button class="btn btn-secondary"
            type="button"
            onclick="if (document.referrer) { window.history.back(); } else { window.location.href = '{% url 'home' %}'; }">
      PowrÃ³t
    </button>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = {{ radar_labels|safe }};
const user_values = {{ radar_user_values|safe }};
const manager_values = {{ radar_manager_values|safe }};

// WybÃ³r typu wykresu: radar na desktop, bar na mobile
const chartType = window.innerWidth < 576 ? 'bar' : 'radar';

const data = {
  labels: labels.map(label => label.length > 20 ? label.substring(0,20) + "â€¦" : label),
  datasets: [
    {
      label: 'Osoba oceniajÄ…ca [%]',
      data: manager_values,
      fill: chartType === 'radar',
     backgroundColor: 'rgba(0, 0, 0, 0.28)',
      borderColor: 'rgba(0, 0, 0, 0.46)',
      borderWidth: 1,
      pointBackgroundColor: chartType === 'radar' ? 'rgba(0, 0, 0, 1)' : undefined
    },
    {
      label: 'Pracownik [%]',
      data: user_values,
      fill: chartType === 'radar',
      backgroundColor: 'rgba(13, 109, 253, 0.28)',
      borderColor: 'rgba(13, 109, 253, 0.46)',
      borderWidth: 1,
      pointBackgroundColor: chartType === 'radar' ? 'rgba(13, 110, 253, 1)' : undefined
    }
  ]
};

const config = {
  type: chartType,
  data: data,
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: chartType === 'radar' ? {
      r: {
        angleLines: { display: true },
        min: 0,
        max: 100,
        ticks: { stepSize: 10, callback: val => val + "%" },
        pointLabels: { font: { size: 18, weight: 'bold' } }
      }
    } : {
      y: {
        min: 0,
        max: 100,
        ticks: { callback: val => val + "%" }
      }
    },
    plugins: {
      legend: {
        position: 'top',
        labels: { font: { size: 14, weight: 'bold' } }
      }
    }
  }
};

new Chart(document.getElementById('radarChart'), config);

// OdÅ›wieÅ¼ wykres przy zmianie rozmiaru ekranu
window.addEventListener('resize', () => location.reload());
</script>

{% endblock %}
