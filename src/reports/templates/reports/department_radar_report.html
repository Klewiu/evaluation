{% extends 'base.html' %}
{% block title %}Radar - raport działu{% endblock %}

{% block content %}

<div class="container mt-4">
  <h1 class="mb-4 text-center header-font text-primary">
    Radar - raport działu {% if selected_department %}{{ selected_department.name }}{% endif %}
  </h1>

  <div class="card shadow-sm mb-4">
  <div class="card-body">
    <h4 class="card-title mb-3 header-font text-center">
      Ankieta: {% if current_survey %}{{ current_survey.name }}{% endif %}
    </h4>
     <p class="text-center header-font text-primary">TYP OCENY: {{ score_type_display }}</p>
    <!-- Kontener zmniejszony -->
    <div class="radar-container" style="max-width:700px; margin:auto;">
      <canvas id="radarChart" height="350"></canvas>
    </div>
  </div>
</div>

  <!-- TABELA WYNIKÓW -->
  <div class="table-responsive mb-5">
    <p class="text-center">Tabela wyników działu {{ selected_department.name }} dla ankiety {% if current_survey %}{{ current_survey.name }}  {% endif %}:</p>
    <p class="text-center text-secondary">Typ oceny: {{ score_type_display }}</p>
    <table class="table table-bordered text-center align-middle">
      <thead class="table-light">
        <tr>
          <th>Pracownik / Kompetencja</th>
          {% for label in radar_labels %}
            <th>{{ label }}</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for emp in radar_data %}
        <tr>
          <td>{{ emp.employee }}</td>
          {% for score in emp.scores %}
            <td>{{ score }}%</td>
          {% endfor %}
        </tr>
        {% endfor %}
        {% if avg_scores %}
        <tr class="table-secondary fw-bold">
          <td>Średnia działu</td>
          {% for score in avg_scores %}
            <td>{{ score }}%</td>
          {% endfor %}
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = {{ radar_labels|safe }};
const radarData = {{ radar_data|safe }};
const avgScores = {{ avg_scores|safe }};

// Mobile / desktop detection
const isMobile = window.innerWidth < 768;

// Colors for datasets
const baseColors = [
    'rgba(54, 162, 235, 0.2)',
    'rgba(255, 99, 132, 0.2)',
    'rgba(255, 206, 86, 0.2)',
    'rgba(75, 192, 192, 0.2)',
    'rgba(153, 102, 255, 0.2)',
    'rgba(255, 159, 64, 0.2)'
];
const borderColors = baseColors.map(c => c.replace('0.2', '0.8'));

// Tworzymy dataset dla każdego pracownika
const datasets = radarData.map((emp, i) => ({
    label: emp.employee,
    data: emp.scores,
    fill: !isMobile,  // radar: fill = true, bar: fill = false
    backgroundColor: baseColors[i % baseColors.length],
    borderColor: borderColors[i % borderColors.length],
    borderWidth: 2,
    pointBackgroundColor: borderColors[i % borderColors.length],
    pointBorderColor: '#fff',
    tension: 0.3
}));

// ŚREDNIA DZIAŁU
if (avgScores.length) {
    datasets.push({
        label: 'Średnia działu',
        data: avgScores,
        fill: false,
        borderColor: 'black',
        borderWidth: 2,
        borderDash: isMobile ? [] : [5, 5], // brak przerywanej linii na bar chart
        backgroundColor: 'rgba(0,0,0,0.2)'
    });
}

// TWORZENIE WYKRESU
new Chart(document.getElementById('radarChart'), {
    type: isMobile ? 'bar' : 'radar',
    data: { labels: labels, datasets: datasets },
    options: {
        responsive: true,
        indexAxis: isMobile ? 'y' : 'x', // poziomy wykres na mobile
        scales: isMobile ? {
            x: {
                beginAtZero: true,
                max: 100,
                ticks: { callback: v => v + "%" }
            }
        } : {
            r: {
                beginAtZero: true,
                max: 100,
                ticks: { stepSize: 10, callback: v => v + "%" },
                pointLabels: {
                    font: {
                        size: window.innerWidth < 768 ? 10 : 14,
                        weight: 'bold'
                    }
                }
            }
        },
        plugins: {
            legend: {
                position: 'top',
                labels: { font: { size: 12 } }
            }
        }
    }
});
</script>
{% endblock %}