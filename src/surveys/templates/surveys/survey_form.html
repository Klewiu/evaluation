{% extends "base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>{{ title }}</h2>
    <form method="post">
        {% csrf_token %}

        <!-- Nazwa ankiety -->
        <div class="mb-3">
            {{ form.name.label_tag }}
            {{ form.name }}
            {% if form.name.errors %}
                <div class="text-danger">{{ form.name.errors }}</div>
            {% endif %}
        </div>

        <!-- Dział -->
        <div class="mb-3">
            {{ form.department.label_tag }}
            {{ form.department }}
            {% if form.department.errors %}
                <div class="text-danger">{{ form.department.errors }}</div>
            {% endif %}
        </div>

        <!-- Rok ankiety -->
        <div class="mb-3">
            {{ form.year.label_tag }}
            {{ form.year }}
            {% if form.year.errors %}
                <div class="text-danger">{{ form.year.errors }}</div>
            {% endif %}
        </div>

        <!-- Pytania (ładowane przez HTMX lub wyświetlane jeśli edycja) -->
        <div id="questions-container" class="mt-3">
            {% if survey and survey.questions.exists %}
                <h5>Wybrane pytania:</h5>
                {% for question in survey.questions.all %}
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               name="questions" value="{{ question.id }}" id="q{{ question.id }}" checked>
                        <label class="form-check-label" for="q{{ question.id }}">
                            {{ question.text }}
                        </label>
                    </div>
                {% endfor %}
            {% endif %}
        </div>

        <!-- Ukryte pole do kolejności pytań (jeśli SortableJS jest używane) -->
        <input type="hidden" name="questions_order" id="questions_order">

        <!-- Przyciski akcji -->
        <button type="submit" class="btn btn-primary">Zapisz</button>
        <a href="{% url 'surveys_list' %}" class="btn btn-secondary">Anuluj</a>
    </form>
</div>

<!-- Sortowanie pytań -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener("htmx:afterSwap", function(event) {
    if (event.detail.target.id === "questions-container") {
        var el = document.getElementById('sortable-questions');
        if (el) {
            Sortable.create(el, {
                animation: 150,
                onEnd: function () {
                    var order = [];
                    el.querySelectorAll('li').forEach(function(li){
                        order.push(li.dataset.id);
                    });
                    document.getElementById('questions_order').value = order.join(',');
                }
            });
        }
    }
});
</script>
{% endblock %}
